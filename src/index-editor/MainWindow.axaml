<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:views="clr-namespace:IndexEditor.Views"
        xmlns:local="clr-namespace:IndexEditor.Views"
        x:Class="IndexEditor.MainWindow"
        Title="IndexEditor">
    <Window.Resources>
        <local:NotNullToBoolConverter x:Key="NotNullToBool" />
    </Window.Resources>
    <Grid RowDefinitions="Auto,*" ColumnDefinitions="*,*,*">
        <!-- Invisible focus host to capture keyboard shortcuts reliably -->
        <Border x:Name="KeyboardFocusHost" Grid.Row="0" Grid.Column="0" Width="1" Height="1" Background="Transparent" Focusable="True" IsHitTestVisible="False" />
        <!-- Top Bar -->
        <Border Grid.Row="0" Grid.ColumnSpan="3">
            <views:TopBar x:Name="TopBarControl"/>
        </Border>
        <!-- Article List (Left 3 columns) -->
        <Border Grid.Row="1" Grid.Column="0">
            <views:ArticleList x:Name="ArticleListControl"/>
        </Border>
        <!-- Article Editor (Center 6 columns) -->
        <Border Grid.Row="1" Grid.Column="1">
            <!-- Show the ArticleEditor only when SelectedArticle is not null -->
            <ContentControl x:Name="EditorContentHost" Content="{Binding}">
                <ContentControl.ContentTemplate>
                    <DataTemplate>
                        <StackPanel>
                            <views:ArticleEditor x:Name="ArticleEditorControl" IsVisible="{Binding SelectedArticle, Converter={StaticResource NotNullToBool}}" />
                            <TextBlock Text="No article selected" IsVisible="{Binding SelectedArticle, Converter={StaticResource NotNullToBool}, ConverterParameter=Invert}" HorizontalAlignment="Center" VerticalAlignment="Center" FontStyle="Italic" Foreground="#666" />
                        </StackPanel>
                    </DataTemplate>
                </ContentControl.ContentTemplate>
            </ContentControl>
        </Border>
        <!-- GridSplitter between Article List and Editor -->
        <GridSplitter Grid.Row="1" Grid.Column="1" Width="6" HorizontalAlignment="Left" VerticalAlignment="Stretch" Background="#DDDDDD" ShowsPreview="True" />
        <!-- GridSplitter between Editor and Page Controller -->
        <GridSplitter Grid.Row="1" Grid.Column="2" Width="6" HorizontalAlignment="Left" VerticalAlignment="Stretch" Background="#DDDDDD" ShowsPreview="True" />
        <!-- Page Controller (Right column) - neutral background; resizable via splitter -->
        <Border Grid.Row="1" Grid.Column="2" Padding="8" MinWidth="200">
            <views:PageControllerView x:Name="PageControllerControl"/>
        </Border>

        <!-- Index file overlay (hidden by default) -->
        <Border x:Name="IndexOverlay" Grid.Row="0" Grid.ColumnSpan="3" Grid.RowSpan="2" Background="#80000000" IsVisible="False">
            <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                <Border Width="800" Height="600" Background="White" CornerRadius="6" Padding="12">
                    <Grid RowDefinitions="Auto,Auto,*,Auto">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                            <Button x:Name="IndexOverlaySaveBtn" Content="Save" />
                            <Button x:Name="IndexOverlayCloseBtn" Content="Close" />
                        </StackPanel>
                        <!-- Error line display (hidden unless parsing error) -->
                        <Border Grid.Row="1" Background="#FFF5F5" Padding="6" CornerRadius="4" IsVisible="False" x:Name="IndexOverlayErrorBorder">
                            <TextBlock x:Name="IndexOverlayErrorLine" FontFamily="'Ubuntu Mono', 'DejaVu Sans Mono', 'Courier New', monospace" Foreground="Red" TextWrapping="NoWrap" />
                        </Border>
                        <TextBox x:Name="IndexOverlayTextBox" Grid.Row="2" TextWrapping="Wrap" AcceptsReturn="True" IsReadOnly="False" FontFamily="'Ubuntu Mono', 'DejaVu Sans Mono', 'Courier New', monospace" FontSize="16" />
                        <TextBlock Grid.Row="3" Text="Press 'i' to close" HorizontalAlignment="Right" FontSize="12" Foreground="#666" />
                    </Grid>
                </Border>
            </Grid>
        </Border>

        <!-- Delete article confirmation overlay (hidden by default) -->
        <Border x:Name="DeleteArticleConfirmOverlay" Grid.Row="0" Grid.ColumnSpan="3" Grid.RowSpan="2" Background="#80000000" IsVisible="False">
            <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                <Border Width="420" Height="160" Background="White" CornerRadius="6" Padding="16">
                    <Grid RowDefinitions="Auto,*,Auto">
                        <TextBlock x:Name="DeleteArticleConfirmMessage" Grid.Row="0" Text="Delete the selected article?" FontWeight="Bold" FontSize="14" TextWrapping="Wrap" />
                        <TextBlock Grid.Row="1" Text="This action will remove the article from the index. You can undo by reopening the folder if needed." TextWrapping="Wrap" Foreground="#333" Margin="0,8,0,0" />
                        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                            <Button x:Name="DeleteArticleConfirmBtn" Content="Delete" />
                            <Button x:Name="DeleteArticleCancelBtn" Content="Cancel" />
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </Border>

        <!-- Help overlay (F1) - shows keyboard shortcuts and brief workflow guidance -->
        <Border x:Name="HelpOverlay" Grid.Row="0" Grid.ColumnSpan="3" Grid.RowSpan="2" Background="#80000000" IsVisible="False">
            <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                <Border Width="700" Height="520" Background="White" CornerRadius="6" Padding="16">
                    <Grid RowDefinitions="Auto,*,Auto">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                            <Button x:Name="HelpOverlayCloseBtn" Content="Close" />
                        </StackPanel>
                        <ScrollViewer Grid.Row="1">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Keyboard Shortcuts" FontWeight="Bold" FontSize="16" />
                                <TextBlock Text="F1: Toggle this help overlay" />
                                <TextBlock Text="Esc: Cancel active segment or close overlays / return focus" />
                                <TextBlock Text="Ctrl+O: Open folder" />
                                <TextBlock Text="Ctrl+S: Save _index.txt" />
                                <TextBlock Text="Ctrl+N: New article" />
                                <TextBlock Text="Ctrl+A: Add / open segment for current article" />
                                <TextBlock Text="Enter / Ctrl+Enter: End active segment or focus first editor field" />
                                <TextBlock Text="← / →: Move to previous / next available page (skip missing pages)" />
                                <TextBlock Text="↑ / ↓: Change active article" />
                                <TextBlock Text="E: focus category combo" />
                                <TextBlock Text="Ctrl+I: Toggle editable _index.txt overlay" />
                                <TextBlock Text="" />
                                <TextBlock Text="Segments" FontWeight="Bold" FontSize="14" />
                                <TextBlock TextWrapping="Wrap">A segment is a contiguous set of pages that belong to an article. Use Ctrl+A to start or open a segment for the current article on the current page. While a segment is active, selection of other articles is locked and page changes update the active segment end. End the segment with Enter or Ctrl+Enter, or cancel with Esc.</TextBlock>
                            </StackPanel>
                        </ScrollViewer>
                        <TextBlock Grid.Row="2" Text="Press F1 to close or Esc" HorizontalAlignment="Right" FontSize="12" Foreground="#666" />
                    </Grid>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Window>
